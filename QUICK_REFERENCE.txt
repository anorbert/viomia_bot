# Quick Reference - Login & Dashboard Implementation

## üöÄ Quick Start

### 1. Apply Database Migrations
```bash
# Create migration for user fields
php artisan make:migration add_login_fields_to_users_table

# Create migration for bot fields
php artisan make:migration add_management_fields_to_bot_statuses_table

# Create audit logs table
php artisan make:migration create_audit_logs_table

# Run migrations
php artisan migrate
```

### 2. Update Models
```bash
# Add relationships and scopes to models
php artisan tinker

# Test bot service
$service = app(App\Services\BotManagementService::class);
$bot = App\Models\BotStatus::first();
$service->getBotStatus($bot);
```

### 3. Test Login
```bash
# Visit login page
http://localhost/login

# Test credentials
Phone: [any existing user's phone]
PIN: [user's password]

# Verify redirect based on role_id
```

---

## üîë Key Classes & Methods

### LoginController
```php
// Show login form
route('login')
->get('/login', [LoginController::class, 'showLoginForm'])

// Process login
route('login')
->post('/login', [LoginController::class, 'login'])

// Logout
route('logout')
->post('/logout', [LoginController::class, 'logout'])
->get('/logout', [LoginController::class, 'logout'])
```

### AdminController
```php
// Admin dashboard with statistics
route('admin.dashboard')
->get('/admin/dashboard', [AdminController::class, 'index'])
// Parameters: ?date_range=7 (days)
```

### BotController
```php
// List bots
route('admin.bots.index')
->get('/admin/bots', [BotController::class, 'index'])

// Create bot
route('admin.bots.store')
->post('/admin/bots', [BotController::class, 'store'])

// View bot
route('admin.bots.show', $bot)
->get('/admin/bots/{id}', [BotController::class, 'show'])

// Update bot
route('admin.bots.update', $bot)
->put('/admin/bots/{id}', [BotController::class, 'update'])

// Delete bot
route('admin.bots.destroy', $bot)
->delete('/admin/bots/{id}', [BotController::class, 'destroy'])

// View logs
route('admin.bots.logs')
->get('/admin/bots/logs?bot_id=1&type=error')

// Get bot JSON status
->get('/admin/bots/{id}/status', [BotController::class, 'getStatus'])
```

### BotManagementService
```php
// Get bot status
$service->getBotStatus($bot)

// Get performance (30-day default)
$service->getBotPerformance($bot, $days = 30)

// Check health
$service->isBotHealthy($bot)

// Check if active
$service->isBotActive($bot)

// Get errors
$service->getBotErrors($bot, $limit = 10)

// Get status changes
$service->getBotStatusChanges($bot, $limit = 10)

// Get uptime
$service->calculateUptimePercentage($bot, $days = 7)

// Fleet summary
$service->getAllBotsSummary()

// Control bot
$service->restartBot($bot)
$service->stopBot($bot)
$service->enableBot($bot)
$service->disableBot($bot)
```

---

## üìã Middleware Usage

### Role-Based Access
```php
// Protect routes by role
Route::middleware(['auth', 'role:admin'])->group(function () {
    // Only admins (role_id = 1)
});

Route::middleware(['auth', 'role:admin,editor'])->group(function () {
    // Admins or editors (role_id = 1 or 2)
});

Route::middleware(['auth', 'role:user'])->group(function () {
    // Regular users (role_id = 3)
});
```

### Check User Active
```php
// Automatically applied to protected routes
// Checks: is_active, soft delete status
// Auto-logout if inactive
```

---

## üíæ Database Schema

### Users Table (Add Columns)
```sql
ALTER TABLE users ADD COLUMN (
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP NULL,
    last_login_ip VARCHAR(45) NULL
);
```

### Bot Status Table (Add Columns)
```sql
ALTER TABLE bot_statuses ADD COLUMN (
    enabled BOOLEAN DEFAULT TRUE,
    max_daily_loss DECIMAL(10,2) NULL,
    max_concurrent_positions INT DEFAULT 10,
    trading_hours_start TIME NULL,
    trading_hours_end TIME NULL,
    last_ping TIMESTAMP NULL,
    name VARCHAR(255) NULL,
    strategy VARCHAR(255) NULL,
    description TEXT NULL
);
```

### Audit Logs Table (Create New)
```sql
CREATE TABLE audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL REFERENCES users(id),
    action VARCHAR(50) NOT NULL,
    model_type VARCHAR(255) NOT NULL,
    model_id BIGINT NOT NULL,
    changes JSON NULL,
    ip_address VARCHAR(45) NULL,
    user_agent TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_model (model_type, model_id),
    INDEX idx_created_at (created_at)
);
```

---

## üß™ Testing Commands

### Test in Tinker
```bash
php artisan tinker

# Get service
$service = app(App\Services\BotManagementService::class)

# Get bot
$bot = App\Models\BotStatus::first()

# Test methods
$service->getBotStatus($bot)
$service->getBotPerformance($bot)
$service->getAllBotsSummary()

# Test middleware
$user = App\Models\User::find(1)
auth()->loginAs($user)
auth()->user()
```

### Test Routes
```bash
# Visit pages in browser
http://localhost/login
http://localhost/admin/dashboard
http://localhost/admin/bots
http://localhost/admin/bots/1
http://localhost/logout

# Test with curl
curl -X POST http://localhost/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"1234567890","pin":"1234"}'
```

---

## üîç Debugging Tips

### Enable Debug Mode
```php
// .env
APP_DEBUG=true
LOG_LEVEL=debug
```

### Check Logs
```bash
# Real-time log monitoring
tail -f storage/logs/laravel.log

# Search logs
grep -i "bot" storage/logs/laravel.log
grep -i "error" storage/logs/laravel.log
grep -i "login" storage/logs/laravel.log
```

### Database Queries
```php
// In tinker, enable query log
DB::enableQueryLog()

// Run queries
$bots = App\Models\BotStatus::all()

// Check queries
dd(DB::getQueryLog())
```

### Test Authentication
```bash
php artisan tinker

# Create test user
$user = User::create([
    'name' => 'Test Admin',
    'email' => 'admin@test.com',
    'phone_number' => '1234567890',
    'password' => Hash::make('1234'),
    'role_id' => 1,
    'is_active' => true
])

# Login
auth()->loginAs($user)
auth()->check() // true
auth()->user()->role_id // 1
```

---

## üìä Common Queries

### Get Dashboard Data
```php
use App\Models\User, App\Models\BotStatus, App\Models\TradeLog;

$totalUsers = User::count();
$activeUsers = User::where('is_active', 1)->count();
$totalBots = BotStatus::count();
$healthyBots = BotStatus::whereNotNull('last_ping')
    ->where('last_ping', '>', now()->subMinutes(5))
    ->count();
$totalTrades = TradeLog::count();
$winningTrades = TradeLog::where('profit_loss', '>', 0)->count();
$totalRevenue = TradeLog::sum('profit_loss');
```

### Get Bot Performance
```php
$bot = BotStatus::find(1);
$trades = TradeLog::where('bot_status_id', $bot->id)
    ->whereDate('created_at', today())
    ->get();

$todayPL = $trades->sum('profit_loss');
$todayTrades = $trades->count();
$todayWins = $trades->where('profit_loss', '>', 0)->count();
```

### Get Recent Errors
```php
use App\Models\ErrorLog;

$recentErrors = ErrorLog::orderBy('created_at', 'desc')
    ->limit(10)
    ->get();
```

---

## ‚öôÔ∏è Configuration

### Auth Configuration
**File:** `config/auth.php`
```php
'defaults' => [
    'guard' => 'web',
    'passwords' => 'users',
],

'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
],

'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => App\Models\User::class,
    ],
],
```

### Middleware Registration
**File:** `bootstrap/app.php`
```php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->alias([
        'role' => \App\Http\Middleware\CheckRole::class,
        'user.active' => \App\Http\Middleware\CheckUserActive::class,
    ]);
})
```

---

## üéØ Common Issues & Solutions

| Issue | Solution |
|-------|----------|
| Login not working | Check user `is_active`, verify `role_id` exists |
| Admin dashboard blank | Check user has `role_id = 1` |
| 403 Unauthorized error | Verify middleware applied, check role |
| Bot status not updating | Check `last_ping` timestamp in database |
| Logout not clearing session | Clear browser cookies and cache |

---

## üìû Commands Cheat Sheet

```bash
# Create controller
php artisan make:controller Admin/BotController --resource

# Create middleware
php artisan make:middleware CheckRole

# Create service
php artisan make:class Services/BotManagementService

# Create model with migration
php artisan make:model BotStatus -m

# Run migrations
php artisan migrate

# Rollback migrations
php artisan migrate:rollback

# Refresh all migrations
php artisan migrate:refresh

# Clear cache
php artisan cache:clear

# Clear config cache
php artisan config:clear

# View routes
php artisan route:list

# Run tinker
php artisan tinker

# Make request
php artisan make:request StoreBotRequest
```

---

## üîê Security Checklist

- [ ] CSRF tokens enabled on forms
- [ ] Password hashing with Hash::make()
- [ ] Role-based middleware applied
- [ ] API key validation working
- [ ] Logging enabled for security events
- [ ] Session timeout configured
- [ ] Database backups automated
- [ ] Error messages don't leak info
- [ ] Input validation on all forms
- [ ] Output escaping in views

---

**Last Updated:** January 3, 2026
